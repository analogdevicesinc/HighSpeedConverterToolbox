function hRD = plugin_rd(project, board, design)
% Reference design definition

%   Copyright 2014-2015 The MathWorks, Inc.

pname = upper(project);
ppath = project;
if strcmpi(project, 'ad9081')
    ppath = 'ad9081_fmca_ebz';
end

% Construct reference design object
hRD = hdlcoder.ReferenceDesign('SynthesisTool', 'Xilinx Vivado');

% Create the reference design for the SOM-only
% This is the base reference design that other RDs can build upon
hRD.ReferenceDesignName = sprintf('%s %s (%s)', pname, upper(board), upper(design));

% Determine the board name based on the design
hRD.BoardName = sprintf('AnalogDevices %s %s', pname, upper(board));

% Tool information
%hRD.SupportedToolVersion = {adi.Version.Vivado}; % FIXME
hRD.SupportedToolVersion = {'2021.1'};

% Get the root directory
rootDir = fileparts(strtok(mfilename('fullpath'), '+'));

% Design files are shared
hRD.SharedRD = true;
hRD.SharedRDFolder = fullfile(rootDir, 'vivado');

%% Set top level project pieces
hRD.addParameter( ...
    'ParameterID',   'project', ...
    'DisplayName',   'HDL Project Subfolder', ...
    'DefaultValue',  lower(ppath));

hRD.addParameter( ...
    'ParameterID',   'carrier', ...
    'DisplayName',   'HDL Project Carrier', ...
    'DefaultValue',  lower(board));


%% Add custom design files
% add custom Vivado design
hRD.addCustomVivadoDesign( ...
    'CustomBlockDesignTcl', fullfile('projects', 'scripts', 'system_project_rxtx.tcl'), ...
    'CustomTopLevelHDL',    fullfile('projects', lower(ppath), lower(board), 'system_top.v'));

hRD.BlockDesignName = 'system';

% custom constraint files
hRD.CustomConstraints = {...
    fullfile('projects', lower(ppath), lower(board), 'system_constr.xdc'), ...
    fullfile('projects', 'common', lower(board), sprintf('%s_system_constr.xdc', lower(board))), ...
    };

% custom source files
hRD.CustomFiles = {...
    fullfile('projects')...,
    fullfile('library')...,
    };

hRD.addParameter( ...
    'ParameterID',   'ref_design', ...
    'DisplayName',   'Reference Type', ...
    'DefaultValue',  lower(strrep(design, ' & ','')));

hRD.addParameter( ...
    'ParameterID',   'fpga_board', ...
    'DisplayName',   'FPGA Boad', ...
    'DefaultValue',  upper(board));

hRD.addParameter( ...
    'ParameterID',   'preprocess', ...
    'DisplayName',   'Preprocess', ...
    'DefaultValue',  'off');

hRD.addParameter( ...
    'ParameterID',   'postprocess', ...
    'DisplayName',   'Postprocess', ...
    'DefaultValue',  'off');

% Add custom JESD parameters

if contains(project, 'ad9081')
hRD.addParameter( ...
    'ParameterID',   'JESD_MODE', ...
    'DisplayName',   'JESD_MODE', ...
    'DefaultValue',  '8B10B', ...
    'ParameterType',  hdlcoder.ParameterType.Dropdown, ...
    'Choice',       {'8B10B', '64B66B'});
hRD.addParameter( ...
    'ParameterID',   'RX_LANE_RATE', ...
    'DisplayName',   'RX_RATE', ...
    'DefaultValue',  '10', ...
    'ParameterType',  hdlcoder.ParameterType.Dropdown, ...
    'Choice',       {'10', '1'});
hRD.addParameter( ...
    'ParameterID',   'TX_LANE_RATE', ...
    'DisplayName',   'TX_RATE', ...
    'DefaultValue',  '10', ...
    'ParameterType',  hdlcoder.ParameterType.Dropdown, ...
    'Choice',       {'10', '1'});
hRD.addParameter( ...
    'ParameterID',   'RX_JESD_M', ...
    'DisplayName',   'RX_JESD_M', ...
    'DefaultValue',  '8', ...
    'ParameterType',  hdlcoder.ParameterType.Dropdown, ...
    'Choice',       {'8', '4'});
hRD.addParameter( ...
    'ParameterID',   'RX_JESD_L', ...
    'DisplayName',   'RX_JESD_L', ...
    'DefaultValue',  '4', ...
    'ParameterType',  hdlcoder.ParameterType.Dropdown, ...
    'Choice',       {'4', '8'});
hRD.addParameter( ...
    'ParameterID',   'RX_JESD_S', ...
    'DisplayName',   'RX_JESD_S', ...
    'DefaultValue',  '1', ...
    'ParameterType',  hdlcoder.ParameterType.Dropdown, ...
    'Choice',       {'1', '1'});
hRD.addParameter( ...
    'ParameterID',   'RX_JESD_NP', ...
    'DisplayName',   'RX_JESD_NP', ...
    'DefaultValue',  '16', ...
    'ParameterType',  hdlcoder.ParameterType.Dropdown, ...
    'Choice',       {'16', '1'});
hRD.addParameter( ...
    'ParameterID',   'RX_NUM_LINKS', ...
    'DisplayName',   'RX_NUM_LINKS', ...
    'DefaultValue',  '1', ...
    'ParameterType',  hdlcoder.ParameterType.Dropdown, ...
    'Choice',       {'1', '1'});
hRD.addParameter( ...
    'ParameterID',   'TX_JESD_M', ...
    'DisplayName',   'TX_JESD_M', ...
    'DefaultValue',  '8', ...
    'ParameterType',  hdlcoder.ParameterType.Dropdown, ...
    'Choice',       {'8', '4'});
hRD.addParameter( ...
    'ParameterID',   'TX_JESD_L', ...
    'DisplayName',   'TX_JESD_L', ...
    'DefaultValue',  '4', ...
    'ParameterType',  hdlcoder.ParameterType.Dropdown, ...
    'Choice',       {'4', '8'});
hRD.addParameter( ...
    'ParameterID',   'TX_JESD_S', ...
    'DisplayName',   'TX_JESD_S', ...
    'DefaultValue',  '1', ...
    'ParameterType',  hdlcoder.ParameterType.Dropdown, ...
    'Choice',       {'1', '1'});
hRD.addParameter( ...
    'ParameterID',   'TX_JESD_NP', ...
    'DisplayName',   'TX_JESD_NP', ...
    'DefaultValue',  '16', ...
    'ParameterType',  hdlcoder.ParameterType.Dropdown, ...
    'Choice',       {'16', '1'});
hRD.addParameter( ...
    'ParameterID',   'TX_NUM_LINKS', ...
    'DisplayName',   'TX_NUM_LINKS', ...
    'DefaultValue',  '1', ...
    'ParameterType',  hdlcoder.ParameterType.Dropdown, ...
    'Choice',       {'1', '1'});
hRD.addParameter( ...
    'ParameterID',   'TDD_SUPPORT', ...
    'DisplayName',   'TDD_SUPPORT', ...
    'DefaultValue',  '0', ...
    'ParameterType',  hdlcoder.ParameterType.Dropdown, ...
    'Choice',       {'0', '1'});
hRD.addParameter( ...
    'ParameterID',   'SHARED_DEVCLK', ...
    'DisplayName',   'SHARED_DEVCLK', ...
    'DefaultValue',  '0', ...
    'ParameterType',  hdlcoder.ParameterType.Dropdown, ...
    'Choice',       {'0', '1'});
end

%% Add interfaces
% add clock interface
AnalogDevices.add_clocks(hRD,project,design)

%% Add IO
AnalogDevices.add_io(hRD,project,board,design);
